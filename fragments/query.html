<h1 id="link-top">Introdução</h1>

<p>
    Esta seção demonstra como criar e executar consultas SQL usando DataB.
</p>

<p>
    Se você não viu o módulo
    <a href="/gettingstarted" class="route link-aux" title="Primeiros passos com DataB">
        Como dá os primeiros passos com a library DataB
    </a>,
    volte para lá e veja como configurará-la para poder usá-la.
</p>

<!--Link de navegação de conteudo-->
<div>
    <h4 class="sub-title">Conteúdo da página</h4>
    <nav class="nav-link-content">
        <ul>
            <li>
                <a href="#title-01">Consultando Dados</a>
            </li>
            <li>
                <a href="#title-02">Ordenando Dados</a>
            </li>
            <li>
                <a href="#title-03">Filtrando Dados</a>
            </li>
            <li>
                <a href="#title-04">Junção De Tabelas</a>
            </li>
        </ul>
    </nav>
</div>

<h1 class="sub-title" id="title-01"># Consultando Dados</h1>

<p></p>

<p>
    Para fazer consultas SQL use o método <code>select()</code> para especificar a lista de campos que serão
    retornados pela consulta. Você pode passar por parâmetro tanto um array de
    nomes de colunas quanto uma lista de nomes de colunas separadas por virgulas. Em seguida, use o 
    método <code>table()</code> para definir em qual tabela será feita a consulta de dados.
</p>

<h5>Usando array como parâmetro:</h5>

<pre class="block-code">
    <code>
        $colunas = array(
            'descricao_produto',
            'preco_compra',
            'preco_venda'
        );

        $result = DataB::select($colunas)
            ->table('produto')
            ->exec()
            ->getAll();

        var_dump($result);
    </code>
</pre>

<h5>Usando lista de campos como parâmetro:</h5>

<pre class="block-code">
    <code>
        $result = DataB::select('descricao', 'preco_compra')
            ->table('produto')
            ->exec()
            ->getAll();

        var_dump($result);
    </code>
</pre>

<p>
    O método <code>exec()</code> é chamado para executar a instrução SQL enquanto o método
    <code>getAll()</code> recupera o resultado retornado pelo o banco de dados.
</p>

<p>Para recuperar todos os campos da tabela use <code>select('*')</code></p>

<h3 class="sub-title">Especificando o método de busca (fetch)</h3>

<p>
    Use <code>getAll()</code> para recuperar todos
    os registros retornados pela consulta:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produto')
            ->exec()
            ->getAll();
            
        var_dump($result);

        SAÍDA >>>

        array (size=5)
            0 => 
                array (size=3)
                'id' => string '1' (length=1)
                'descricao' => string 'CR HID SKALA 1KG' (length=16)
                'preco_venda' => string '6.55' (length=4)
            1 => 
                array (size=3)
                'id' => string '2' (length=1)
                'descricao' => string 'CR DENTAL COLG 90G' (length=18)
                'preco_venda' => string '3.89' (length=4)
            ...
    </code>
</pre>

<p>
    Use <code>getFirst()</code> para recuperar o primeiro
    registro retornado pela consulta:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produto')
            ->exec()
            ->getFirst();
            
        var_dump($result);

        SAÍDA >>>

        array (size=3)
            'id' => string '1' (length=1)
            'descricao' => string 'CR HID SKALA 1KG' (length=16)
            'preco_venda' => string '6.55' (length=4)
    </code>
</pre>

<p>
    Use <code>getLast()</code> para recuperar o último
    registro retornado pela consulta:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produto')
            ->exec()
            ->getLast();
            
        var_dump($result);

        SAÍDA >>>

        array (size=3)
            'id' => string '10' (length=1)
            'descricao' => string 'DES AER DOVE 150ML' (length=16)
            'preco_venda' => string '13.50' (length=4)
    </code>
</pre>

<p>
    Use <code>getSingleResult()</code> para recuperar o valor de uma
    coluna específica. Observe que este método não retorna um array contento o resultado
    da consulta mas sim o valor literal da coluna. Veja como funciona:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('descricao')
            ->table('produto')
            ->cond('id')
            ->eq(1)
            ->exec()
            ->getSingleResult();
            
        var_dump($result);

        SAÍDA >>>

        'CR HID SKALA 1KG'

    </code>
</pre>

<p>
    No exemplo acima foi usada uma condição para limitar a quantidade de registros retornados pela
    consulta. Se nenhuma condição for definida, então o método <code>getSingleResult()</code> irá
    retornar o valor da primeira coluna do primeiro registro encontrado.
</p>

<p>
    Use <code>getObjects()</code> para recuperar todos os
    registros como objetos. Este método recebe por
    parâmetro o nome da classe que será usada para criar as instâncias dos objetos.
    Se nenhum parâmetro for especificado, então os registros serão retornados como
    objetos 'stdClass':
</p>

<pre class="block-code">
    <code>

        class Produto {

        }
        
        $rs = DataB::select('*')
                ->table('produtos')
                ->exec()
                ->getObjects('Produto');
        
        var_dump($rs);

        SAÍDA >>>

        array (size=5)
            0 => 
                object(Produto)[2]
                public 'id' => string '1' (length=1)
                public 'descricao' => string 'CR HID SKALA 1KG' (length=16)
                public 'preco_compra' => string '4.98' (length=4)
                public 'preco_venda' => string '6.55' (length=4)
            1 => 
                object(Produto)[6]
                public 'id' => string '2' (length=1)
                public 'descricao' => string 'CR DENTAL COLG 90G' (length=18)
                public 'preco_compra' => string '1.97' (length=4)
                public 'preco_venda' => string '3.89' (length=4)
            ...
    </code>
</pre>

<p>
    Use <code>getObject()</code> para recuperar o primeiro
    registro como objeto. Este método recebe por
    parâmetro o nome da classe que será usada para criar a instância do objeto.
    Se nenhum parâmetro for especificado, então o primeiro registro será retornado como
    um objeto 'stdClass'.
</p>

<p>
    Use <code>getLazy()</code> para recuperar o primeiro
    registro como um objeto PDORow onde as variáveis desse objeto correspondem
    aos nomes das colunas da tabela. Esse método faz o carregamento dos
    dados conforme as variáveis do objeto PDORow forem acessadas.
</p>

<h3 class="sub-title">Consultas nativas</h3>

<p>
    Para executar consultas nativas use <code>DataB::nativeSQL()</code>.
    Este método executa qualquer instrução SQL, tanto
    DML quanto DDL.
</p>

<h5>Executando instrução DML</h5>

<pre class="block-code">
    <code>
        $sql = 'select * from produto';
        $produtos = DataB::nativeSQL($sql)->getAll();
    </code>
</pre>

<h5>Executando instrução DDL</h5>

<pre class="block-code">
    <code>
        $sql = 'alter table usuario add column level int(2)';
        $rowCount = DataB::statement($sql)->rows();
    </code>
</pre>

<h3 class="sub-title">Funções de agregação</h3>

<h5>Calculando a quantidade de registros de uma consulta:</h5>

<pre class="block-code">
    <code>
        $result = DataB::count('*')
            ->table('produto')
            ->exec()
            ->getSingleResult();
    </code>
</pre>

<h5>Calculando o valor mínimo de todos os valores de um conjunto:</h5>

<pre class="block-code">
    <code>
        $result = DataB::min('preco_compra')
        ->table('produto')
        ->exec()
        ->getSingleResult();
    </code>
</pre>

<h5>Calculando o valor máximo de todos os valores de um conjunto:</h5>

<pre class="block-code">
    <code>
        $result = DataB::max('preco_compra')
        ->table('produto')
        ->exec()
        ->getSingleResult();
    </code>
</pre>

<h5>Calculando a média de todos os valores de um conjunto:</h5>

<pre class="block-code">
    <code>
        $result = DataB::avg('preco_venda')
        ->table('produto')
        ->exec()
        ->getSingleResult();
    </code>
</pre>

<h5>Calculando a soma de todos os valores de um conjunto:</h5>

<pre class="block-code">
    <code>
        $result = DataB::sum('preco_venda')
        ->table('produto')
        ->exec()
        ->getSingleResult();
    </code>
</pre>

<h3 class="sub-title">Executando funções nativas</h3>

<p>
    Use <code>DataB::fn()</code> para executar de forma nativa qualquer função disponível
    no banco de dados. O primeiro parâmetro passado para esse método deve ser o nome da função
    a ser executada; os demais, são parâmetros de entradas para a função.
</p>

<h5>Executando função <code>concat</code>:</h5>
<pre class="block-code">
    <code>
        $result = DataB::fn('concat', 'nome', 'sobrenome')
        ->table('cliente')
        ->exec()
        ->getAll();
    </code>
</pre>

<h5>Executando função <code>count</code>:</h5>
<pre class="block-code">
    <code>
        $result = DataB::fn('count', '*')
        ->table('cliente')
        ->exec()
        ->getSingleResult();
    </code>
</pre>

<h1 class="sub-title" id="title-02"># Ordenando Dados</h1>

<p>
    Para ordenar dados use os métodos <code>orderByAsc()</code> e
    <code>orderByDesc()</code>. Esses métodos recebem como parâmetro
    a(s) coluna(s) que serão usadas na ordenação dos dados.
    Observe os exemplos a seguir:
</p>

<h5>Ordenação ascendente.</h5>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
        ->table('produto')
        ->orderByAsc('descricao')
        ->exec()
        ->getAll();
    </code>
</pre>

<h5>Ordenação descendente.</h5>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
        ->table('produto')
        ->orderByDesc('descricao')
        ->exec()
        ->getAll();
    </code>
</pre>

<h5>Usando colunas para ordenação.</h5>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
        ->table('cliente')
        ->orderByAsc('nome', 'idade')
        ->exec()
        ->getAll();
    </code>
</pre>

<h1 class="sub-title" id="title-03"># Filtrando Dados</h1>

<h3 class="sub-title">Cláusula where</h3>

<p>
    Use o método <code>cond()</code> para adicionar a cláusula where à
    consulta SQL:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produtos')
            ->cond('preco_venda')
            ->eq(2.00)
            ->exec()
            ->getAll();

        SQL Gerada >>>

        'select * from produtos where preco_venda = ?'
    </code>
</pre>

<p>
    Observe a instrução SQL gerada no exemplo acima onde temos o campo
    <code>preco_venda = ?</code>. Por padrão, todos os parâmetros de entrada 
    para a instrução SQL são convertidos para <strong>mask placeholders</strong> para evitar
    SQL Injection.
</p>

<p>
    Existem duas maneiras para criar parâmetros SQL com dados de entrada usando DataB.
    A primeira é através de métodos que recebem algum valor de entrada, como por exemplo o
    método <code>eq()</code> que equivale ao operador relacional de igualdade.  A segunda é 
    passando um array de dados para o método <code>exec()</code>. Ao trabalhar desta forma, 
    fica ao seu critério usar <strong>mask placeholders</strong> ou <strong>named placeholders</strong>. 
    Se você optar por esta, deverá passar um array associativo onde as chaves do array devem 
    corresponder aos nomes das colunas da tabela; caso opte por aquela, então você terá que 
    passar um array indexado como parâmentro. Veja como funciona:
</p>

<h5>Usando mask placeholders:</h5>

<pre class="block-code">
    <code>
        $data = array(
            'abc@gmail.com',
        );

        $result = DataB::select('*')
            ->table('usuario')
            ->cond('email')
            ->eq('?')
            ->exec($data)
            ->getAll();

        SQL Gerada >>>

        'select * from usuario where email = ?'

    </code>
</pre>

<h5>Usando named placeholders:</h5>

<pre class="block-code">
    <code>

        $data = array(
            'email' => 'abc@gmail.com',
            'senha' => 12345
        );

        $result = DataB::select('*')
            ->table('usuario')
            ->cond('email')
            ->eq(':email')
            ->and('senha')
            ->eq(':senha')
            ->exec($data)
            ->getAll();

        SQL Gerada >>>

        select * from usuario where email = :email
            and senha = :senha'

    </code>
</pre>

<h3 class="sub-title">Operadores relacionais</h3>

<p>
    Use os seguintes métodos para comparar valores com DataB:
</p>

<ul>
    <li>
        <code>eq()</code> (=)
    </li>
    <li>
        <code>ne()</code> (!=)
    </li>
    <li>
        <code>lt()</code> (&lt;)
    </li>
    <li>
        <code>gt()</code> (&gt;)
    </li>
    <li>
        <code>le()</code> (&lt;=)
    </li>
    <li>
        <code>ge()</code> (&gt;=)
    </li>
</ul>

<p>
    Os métodos de comparação recebem como parâmetro um valor a ser comparado ou uma função
    callback que é usada para criar <a href="#title-">subqueries</a>. Veja um exemplo básico de uso:
</p>

<pre class="block-code">
    <code>
        $precoCompra = 1.99;
        $precoVenda = 12.59;

        $result = DataB::select('*')
            ->table('produtos')
            ->cond('preco_compra')
            ->gt($precoCompra)
            ->or('preco_venda')
            ->lt($precoVenda)
            ->exec()
            ->getAll();
        
        SQL Gerada >>>
            'select * from produtos where preco_compra > ?
                    or preco_venda &lt; ?'
    </code>
</pre>

<p>
    Para fazer comparação entre campos de tabela, use o método <code>DataB::field()</code> para incluir o campo a ser comparado na instrução. Observe no trecho de código abaixo que demonstra a consulta de todos os
    produtos e seus respectivos valores de estoque:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('p.descricao', 'e.atual')
            ->table('produtos as p, estoque as e')
            ->cond('p.id')
            ->eq()
            ->field('e.produto_id')
            ->exec()
            ->getAll();

        SQL Gerada >>>
            'select p.descricao, e.atual from produtos as p, estoque as e 
                where p.id = e.produto_id'
    </code>
</pre>

<h3 class="sub-title">Operadores lógicos</h3>

<h5>Operadores AND e OR</h5>

<p>
    Para combinar duas ou mais expressões lógicas, use os métodos <code>DataB::and()</code> e
    <code>DataB::or()</code>. Esses métodos recebem como parâmetro um nome de um campo
    a ser incluído na expressão ou uma função callback que é usada para criar 
    <a href="#title">subexpressões</a>. Observe o trecho de código abaixo:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produtos as p, estoque as e')
            ->cond('p.id')
            ->eq()
            ->field('e.produto_id')
            ->and('p.preco_venda')
            ->ge(15.99)
            ->or('p.preco_compra')
            ->le(1.99)
            ->exec()
            ->getAll();

        SQL Gerada >>>
            'select * from produtos as p, estoque as e 
                where p.id = e.produto_id 
                    and p.preco_venda >= ? or p.preco_compra &lt;= ?'
    </code>
</pre>

<h5>Operadores IN e NOT IN. </h5>

<p>
    Use os métodos <code>DataB::in()</code> e <code>DataB::notIn()</code>, respectivamente.
    Você pode passar por parâmetro tanto um array de valores quanto um conjunto de valores
    separados por vírgula. Veja como funciona:
</p>

<h6>Passando um conjunto de valores por parâmetro:</h6>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('fruta')
            ->cond('nome')
            ->in('Banana', 'Maçã', 'Uva')
            ->exec()
            ->getAll();

        SQL Gerada >>>
            'select * from frutas where nome in(?, ?, ?)'
    </code>
</pre>

<h6>Passando um array de valores por parâmetro:</h6>

<pre class="block-code">
    <code>
        $frutas = array('Pera', 'Laranja', 'Goiaba');

        $result = DataB::select('*')
            ->table('fruta')
            ->cond('nome')
            ->notIn($frutas)
            ->exec()
            ->getAll();

        SQL Gerada >>>
            'select * from frutas where nome not in(?, ?, ?)'
    </code>
</pre>

<h5>Operadores BETWEEN e NOT BETWEEN</h5>

<p>
    Para incluir estes operadores na instrução SQL use os métodos
    <code>DataB::between()</code> e <code>DataB::notBetween()</code>:
</p>

<pre class="block-code">
    <code>

        $result = DataB::select('*')
            ->table('produtos')
            ->cond('preco_venda')
            ->between(4.99, 12.00)
            ->exec()
            ->getAll();

        SQL Gerada >>>
            'select * from produtos where preco_venda between ? and ?'
    </code>
</pre>

<h5>Operador LIKE</h5>

<p>
    DataB disponibiliza três métodos para se trabalhar com o operador <code>LIKE</code>:
</p>

<ul>
    <li>
        <code>DataB::startsWith()</code> - Busca por um valor que começa com um padrão.
    </li>
    <li>
        <code>DataB::contains()</code>   - Busca por um valor que contêm um padrão.
    </li>
    <li>
        <code>DataB::endsWith()</code>   - Busca por um valor que termina com um padrão.
    </li>
</ul>

<p>
    Esses métodos recebem como parâmetros o padrão a ser usado na busca de valores.
    Observe:
</p>

<pre class="block-code">
    <code>

        $result = DataB::select('*')
            ->table('frutas')
            ->cond('nome')
            ->startsWith('M')
            ->exec()
            ->getAll();

        SQL Gerada >>>

            array (size=2)
                0 => 
                array (size=2)
                    'id' => string '1' (length=1)
                    'nome' => string 'Maçã' (length=6)
                1 => 
                array (size=2)
                    'id' => string '7' (length=1)
                    'nome' => string 'Melancia' (length=8)
    </code>
</pre>

<p>
    Veja o mesmo exemplo acima só que usando o método <code>DataB::exec()</code> para receber o
    padrão como parâmetro:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('frutas')
            ->cond('nome')
            ->startsWith('?')
            ->exec('M%')
            ->getAll();
    </code>
</pre>

<h5>Operadores IS NULL e IS NOT NULL</h5>

<p>
    Use os métodos <code>DataB::isNull()</code> e <code>DataB::isNotNull()</code>, respectivamente.
    Observe:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('frutas')
            ->cond('nome')
            ->isNotNull()
            ->exec()
            ->getAll();
    </code>
</pre>

<h3>Restringindo o número de linhas retornados pela consulta</h3>

<p>
    Use <code>DataB::limit()</code>:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produtos')
            ->limit(10)
            ->exec()
            ->getAll();
    </code>
</pre>

<p>
    Você pode especificar também o número de linhas a pular antes de retornar o resultado 
    da consulta. Observe:
</p>

<pre class="block-code">
    <code>
        $result = DataB::select('*')
            ->table('produtos')
            ->limit(10, 2)
            ->exec()
            ->getAll();

        SQL Gerada:
            'select * from produtos limit 2, 10'
    </code>
</pre>

<p>
    No trecho de código acima, buscamos por dez registros da tabela <code>produtos</code>, inicando
    na linha seguinte depois da linha <code>2</code>.
</p>

<h3>
    Buscando dados não duplicados
</h3>

<p>Use o método <code>DataB::distinct()</code>:</p>

<pre class="block-code">
    <code>
        $result = DataB::distinct('descricao')
            ->table('produtos')
            ->exec()
            ->getAll();

        SQL Gerada:
            'select distinct descricao from produtos'
    </code>
</pre>

<h1 class="sub-title" id="title-04"># Junção de Tabelas</h1>

<p>
    Para você unir duas ou mais tabelas com DataB, use os métodos
</p>

